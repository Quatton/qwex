modules:
  __internal__:register_dependency:
    deps: ""
    code: |
      __internal__:register_dependency () {
        local module_name="$1"
        local deps="$2"
        MODULE_DEPENDENCIES_HASHSET["$module_name"]="$deps"
      }

  __internal__:collect_dependencies:
    deps: "log:debug"
    code: |
      __internal__:collect_dependencies () {
        # traverse through dependencies recursively
        local module_name="$1"
        local deps="${MODULE_DEPENDENCIES_HASHSET[$module_name]}"
        local result=()
        for dep in $deps; do
          result+=($(__internal__:collect_dependencies "$dep"))
          result+=("$dep")
        done
        # remove duplicates
        local unique_result=()
        declare -A seen
        for item in "${result[@]}"; do
          if [[ -z "${seen[$item]+x}" ]]; then
            seen[$item]=1
            unique_result+=("$item")
          fi
        done
        echo "${unique_result[@]}"
      }

  __internal__:include:
    deps: "std:color log:debug"
    code: |
      __internal__:include() {
        std:once "std:color"
        log:debug "Initializing __internal__: $@"

        local unique_result=()
        declare -A seen

        local dependencies=($(__internal__:collect_dependencies "$@"))
        dependencies+=("$@")
        for item in "${dependencies[@]}"; do
          if [[ -z "${seen[$item]+x}" ]]; then
            seen[$item]=1
            unique_result+=("$item")
          fi
        done

        log:debug "${Q_BLUE}Redeclaring context for a new shell boundary...${Q_RESET}"

        declare -f "${unique_result[@]}"
      }

  ssh:exec:
    deps: ""
    code: |
      ssh:exec() {
        ssh csc "$@"
      }

  run:
    deps: "std:step ssh:exec"
    code: |
      run() {
        std:step "Echo" "echo Hello, World!"
        std:step "Remote" "ssh:exec echo 'Remote command executed.'"
        std:step "Steps inside Remote" "ssh:exec bash -s << 'EOF'"
        # Note: when reconstructing from YAML, embed the included module code
        # from `std.yaml` before the remote steps.
      }

  help:
    deps: "log:debug"
    code: |
      help() {
        echo "Usage: $0 [command]"
        echo ""
        echo "Commands:"
        echo "  run       Execute the test run sequence."
        echo "  help      Show this help message."
      }
