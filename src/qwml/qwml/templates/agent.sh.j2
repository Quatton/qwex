{# agent.sh.j2 - Executes command with logging and status reporting #}
{# Props: qwex_home, run_id, stream_output (bool) #}
{% set qh = (qwex_home | default("~/.qwex")).rstrip("/") %}
{% set run_path = qh ~ "/runs/" ~ (run_id | default("unknown")) %}

# Agent: execute command with logging
mkdir -p {{ run_path }}
echo '{"status": "running", "ts": "'$(date -u +%Y-%m-%dT%H:%M:%S+00:00)'"}' >> {{ run_path }}/statuses.jsonl

{% if stream_output | default(true) %}
# Run with output capture (POSIX-compatible, streams to terminal)
{ "$@"; echo $? > /tmp/qwex_exit_$$.tmp; } 2>&1 | tee {{ run_path }}/stdout.log
EXIT_CODE=$(cat /tmp/qwex_exit_$$.tmp)
rm -f /tmp/qwex_exit_$$.tmp
{% else %}
# Run with output redirect (no terminal output)
"$@" > {{ run_path }}/stdout.log 2>&1
EXIT_CODE=$?
{% endif %}

# Report final status
if [ "$EXIT_CODE" -eq 0 ]; then
    echo '{"status": "succeeded", "ts": "'$(date -u +%Y-%m-%dT%H:%M:%S+00:00)'"}' >> {{ run_path }}/statuses.jsonl
else
    echo '{"status": "failed", "ts": "'$(date -u +%Y-%m-%dT%H:%M:%S+00:00)'"}' >> {{ run_path }}/statuses.jsonl
fi
exit $EXIT_CODE
