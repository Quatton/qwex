modules:
  utils:
    uses: std/utils
  log:
    uses: std/log

tasks:
  step:
    vars:
      description: ""
      command: ""
    cmd: |
      local description=${1:-"{{ vars.description }}"}
      shift
      local command=${*:-"{{ vars.command }}"}

      printf '%s %s %s\n' \
        "{{ "┌──" | color("#808080") }} {{ "Step:" | color("blue") }} $description" \
        "{{ "in" | color("#808080") }}" \
        "$(echo "$PWD" | sed "s|^$HOME|~|")" >&2

      local truncated_command="${command:0:60}"

      if [ "${#command}" -gt 60 ]; then
        truncated_command="${truncated_command}..."
      fi

      {{ log.tasks.debug }} "{{ "│ Executing:" | color("#808080") }} $truncated_command"

      local start_time=$(date +%s)

      local exit_code=$?
      if eval "$command"; then
        exit_code=0
      else
        exit_code=$?
      fi

      local end_time=$(date +%s)
      local duration=$((end_time - start_time))

      if [ $exit_code -eq 0 ]; then
        printf '%s\n' "{{ "└─" | color("#808080") }} {{ "✔ Success" | color("green") }} {{ "(${duration}s)" | color("#808080") }}" >&2
      else
        printf '%s\n' "{{ "└─" | color("#808080") }} {{ "✘ Failed" | color("red") }} {{ "(Exit Code: ${exit_code})" | color("#808080") }}" >&2
        return $exit_code
      fi

  compose:
    vars:
      steps: []
    cmd: |
      local failed=false
      local failed_desc=""

      {% for step in vars.steps %}
      # Step: {{ step.desc }}
      if [ "$failed" = false ] || [ "{{ step.always | default(false) }}" = "true" ]; then
        if ! {{ tasks.step }} "{{ step.desc | escape }} {{ "(always)" if step.always }}" "{{ step.cmd }}";

        then
          failed=true
          failed_desc="{{ step.desc }}"
        fi
      fi

      cd "$ORIGINAL_PWD"
      {% endfor %}

      if [ "$failed" = true ]; then
        {{ modules.log.tasks.error }} "Step \"${failed_desc}\" failed. Exiting with error."
        return 1
      fi
