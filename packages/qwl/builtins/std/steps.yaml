modules:
  utils:
    uses: std/utils
  log:
    uses: std/log

tasks:
  step:
    vars:
      description: ""
      command: ""
    cmd: |
      local description=${1:-"{{ vars.description }}"}
      shift
      local command=${*:-"{{ vars.command }}"}

      printf '%s\n' "{{ "┌──" | color("#808080") }} {{ "Step:" | color("blue") }} $description" >&2

      local truncated_command=$(echo "$command" | head -c 60)
      {{ log.tasks.debug }} "{{ "│ Executing:" | color("#808080") }} $truncated_command"

      local start_time=$(date +%s)

      bash -c "$command"

      local exit_code=$?
      local end_time=$(date +%s)
      local duration=$((end_time - start_time))

      if [ $exit_code -eq 0 ]; then
        printf '%s\n' "{{ "└─" | color("#808080") }} {{ "✔ Success" | color("green") }} {{ "(${duration}s)" | color("#808080") }}" >&2
      else
        printf '%s\n' "{{ "└─" | color("#808080") }} {{ "✘ Failed" | color("red") }} {{ "(Exit Code: ${exit_code})" | color("#808080") }}" >&2
        return $exit_code
      fi

  compose:
    vars:
      steps: []
    # This should not inline the steps!
    cmd: |
      {% for step in vars.steps %}
      # Step: {{ step.desc }}
      {% if step.as %}
      local {{ step.as }}
      {{ step.as }}=$({{ tasks.step }} "{{ step.desc }}" '{{ step.cmd }}')
      {% else %}
      {{ tasks.step }} "{{ step.desc }}" "{{ step.cmd }}"
      {% endif %}
      {% endfor %}
