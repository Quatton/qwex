modules:
  utils:
    uses: std/utils
  log:
    uses: std/log

tasks:
  step:
    vars:
      description: ""
      command: ""
    cmd: |
      if [ -z "${__STEP_INDENT+set}" ]; then
        export __STEP_INDENT=""
      fi

      local description=${1:-"{{ vars.description | escape }}"}
      shift
      local command=${*:-"{{ vars.command }}"}

      if {{ log.tasks.should_log }} "INFO"; then
        printf '%s %s %s %s\n' \
          "${__STEP_INDENT}{{ "┌──" | color("#808080") }} {{ "Step:" | blue }} $description" \
          "{{ "in" | color("#808080") }}" \
          "$(echo "$PWD" | sed "s|^$HOME|~|")" "" >&2
      fi

      {{ log.tasks.debug }} "${__STEP_INDENT}{{ "│ Executing:" | color("#808080") }} $command"

      local start_time=$(date +%s)

      local exit_code=$?
      if eval "$command"; then
        exit_code=0
      else
        exit_code=$?
      fi

      local end_time=$(date +%s)
      local duration=$((end_time - start_time))

      if [ $exit_code -eq 0 ]; then
        if {{ log.tasks.should_log }} "INFO"; then
            printf '%s\n' "${__STEP_INDENT}{{ "└─" | color("#808080") }} {{ "✔ Success" | color("green") }} {{ "(${duration}s)" | color("#808080") }}" >&2
        fi
      else
        if {{ log.tasks.should_log }} "ERROR"; then
          printf '%s\n' "${__STEP_INDENT}{{ "└─" | color("#808080") }} {{ "✘ Failed" | color("red") }} {{ "(Exit Code: ${exit_code})" | color("#808080") }}" >&2
          return $exit_code
        fi
      fi

  compose:
    vars:
      steps: []
    cmd: |
      # if __STEP_INDENT is undefined, set it to ""
      if [ -z "${__STEP_INDENT+set}" ]; then
        export __STEP_INDENT=""
      # else increment __STEP_INDENT
      else
        export __STEP_INDENT="$__STEP_INDENT  "
      fi


      local failed=false
      local failed_desc=""

      {% for step in vars.steps %}
      # Step: {{ step.desc }}
      if [ "$failed" = false ] || [ "{{ step.always | default(false) }}" = "true" ]; then
        if ! {{ tasks.step }} "{{ step.desc | escape }} {{ "(always)" if step.always }}" "{{ step.cmd | escape }}";

        then
          failed=true
          failed_desc="{{ step.desc | escape }}"
        fi
      fi

      cd "$ORIGINAL_PWD"
      {% endfor %}

      if [ "$failed" = true ]; then
        {{ log.tasks.error }} "Step \"${failed_desc}\" failed. Exiting with error."
        return 1
      fi

      # decrement __STEP_INDENT by removing two spaces only if it's not empty
      if [ -n "$__STEP_INDENT" ]; then
        export __STEP_INDENT="${__STEP_INDENT:0:-2}"
      fi
