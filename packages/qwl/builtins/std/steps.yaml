modules:
  utils:
    uses: std/utils
  log:
    uses: std/log

tasks:
  step:
    cmd: |
      {{ utils.once }} "utils:color" "{{ utils.color }}"
      {{ log.info }} "${Q_GRAY}┌── ${Q_BLUE}Step: $1${Q_RESET}"

      local command_str="$2"
      local truncated_command_str=$(echo "$command_str" | head -c 60)
      {{ log.debug }} "${Q_GRAY}│ Executing: ${truncated_command_str}${Q_RESET}"

      local start_time=$(date +%s)

      eval "$command_str"
      local exit_code=$?

      local end_time=$(date +%s)
      local duration=$((end_time - start_time))

      if [ $exit_code -eq 0 ]; then
        {{ log.info }} "${Q_GRAY}└─ ${Q_GREEN}✔ Success${Q_GRAY} (${duration}s)${Q_RESET}"
        return 0
      else
        {{ log.error }} "${Q_GRAY}└─ ${Q_RED}✘ Failed${Q_GRAY} (Exit Code: ${exit_code})${Q_RESET}"
        return $exit_code
      fi

  compose:
    vars:
      steps: "[]"
    cmd: |
      for step in "${steps[@]}"; do
        IFS='|' read -r step_name step_command <<< "$step"
        {{ tasks.step }} "$step_name" "$step_command"
        local step_exit_code=$?
        if [ $step_exit_code -ne 0 ]; then
          return $step_exit_code
        fi
      done
