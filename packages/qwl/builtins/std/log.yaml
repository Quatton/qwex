modules:
  utils:
    uses: std/utils

vars:
  level_to_num: |
    case "$1" in
      TRACE|trace|1) echo 1 ;;
      DEBUG|debug|2) echo 2 ;;
      INFO|info|3)   echo 3 ;;
      WARN|warn|WARNING|warning|4) echo 4 ;;
      ERROR|error|5) echo 5 ;;
      *) echo 3 ;;
    esac

tasks:
  _should_log:
    cmd: |
      local msg_level="$1"
      local current_level="${QWEX_LOG_LEVEL:-INFO}"
      local msg_num current_num
      msg_num=$({{ vars.level_to_num }})
      current_num=$(echo "$current_level" | xargs -I{} bash -c '{{ vars.level_to_num }}' _ {})
      [ "$msg_num" -ge "$current_num" ]

  trace:
    cmd: |
      {{ utils.once }} "utils:color" "{{ utils.color }}"
      if {{ tasks._should_log }} 1; then
        echo -e "${Q_GRAY}[TRACE]${Q_RESET} $1" >&2
      fi

  debug:
    cmd: |
      {{ utils.once }} "utils:color" "{{ utils.color }}"
      if {{ tasks._should_log }} 2; then
        echo -e "${Q_GRAY}[DEBUG]${Q_RESET} $1" >&2
      fi

  info:
    cmd: |
      {{ utils.once }} "utils:color" "{{ utils.color }}"
      if {{ tasks._should_log }} 3; then
        echo -e "${Q_BLUE}ℹ${Q_RESET} $1" >&2
      fi

  warn:
    cmd: |
      {{ utils.once }} "utils:color" "{{ utils.color }}"
      if {{ tasks._should_log }} 4; then
        echo -e "${Q_YELLOW}⚠${Q_RESET} $1" >&2
      fi

  error:
    cmd: |
      {{ utils.once }} "utils:color" "{{ utils.color }}"
      if {{ tasks._should_log }} 5; then
        echo -e "${Q_RED}✘${Q_RESET} $1" >&2
      fi
