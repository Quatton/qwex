modules:
  utils:
    uses: std/utils

vars:
  level_to_num: |
    case "${1:-}" in
      TRACE|trace|1) echo 1 ;;
      DEBUG|debug|2) echo 2 ;;
      INFO|info|3)   echo 3 ;;
      WARN|warn|WARNING|warning|4) echo 4 ;;
      ERROR|error|5) echo 5 ;;
      *) echo 3 ;;
    esac

tasks:
  should_log:
    cmd: |
      local msg_level="${1:-INFO}"
      local current_level="${LOG_LEVEL:-INFO}"

      _to_num() {
        {{ vars.level_to_num }}
      }

      local msg_num=$(_to_num "$msg_level")
      local current_num=$(_to_num "$current_level")

      [ "$msg_num" -ge "$current_num" ]

  _timestamp:
    cmd: |
      date '+%Y-%m-%d %H:%M:%S'

  trace:
    cmd: |
      if {{ tasks.should_log }} 1; then
        printf '%s {{ "[TRACE]" | color("#808080") }} %s\n' "$({{ tasks._timestamp }})" "$1" >&2
      fi

  debug:
    cmd: |
      if {{ tasks.should_log }} 2; then
        printf '%s {{ "[DEBUG]" | color("#808080") }} %s\n' "$({{ tasks._timestamp }})" "$1" >&2
      fi

  info:
    cmd: |
      if {{ tasks.should_log }} 3; then
        printf '%s {{ "ℹ" | color("blue") }} %s\n' "$({{ tasks._timestamp }})" "$1" >&2
      fi

  warn:
    cmd: |
      if {{ tasks.should_log }} 4; then
        printf '%s {{ "⚠" | color("yellow") }} %s\n' "$({{ tasks._timestamp }})" "$1" >&2
      fi

  error:
    cmd: |
      if {{ tasks.should_log }} 5; then
        printf '%s {{ "✘" | color("red") }} %s\n' "$({{ tasks._timestamp }})" "$1" >&2
      fi
