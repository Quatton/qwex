#!/usr/bin/env bash
set -euo pipefail

@help() {
  echo "Available tasks:"
{% for task in main %}
  echo "  {{ task.name }}{% if task.desc %} - {{ task.desc }}{% endif %}"
{% endfor %}
}

{% for task in deps %}
{% if task.desc %}
# {{ task.desc }}
{% endif %}
# Hash: {{ task.hash }}
{{ task.name | replace(".", ":") }}() {
  {{ task.cmd }}
}

{% endfor %}
{% for task in main %}
{% if task.desc %}
# {{ task.desc }}
{% endif %}
# Hash: {{ task.hash }}
{{ task.name | replace(".", ":") }}() {
  {{ task.cmd }}
}

{% endfor %}
@main() {
  case "${1:-}" in
    ""|"-h"|"--help"|"help")
      @help
      ;;
{% for task in main %}
    "{{ task.name }}")
      shift
      {{ task.name | replace(".", ":") }} "$@"
      ;;
{% endfor %}
    *)
      echo "Unknown task: $1" >&2
      @help
      exit 1
      ;;
  esac
}

@main "$@"
