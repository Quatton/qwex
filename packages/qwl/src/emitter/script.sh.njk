#!/usr/bin/env bash

QWEX_PREAMBLE="set -uo{{ 'x' if env.DEBUG }} pipefail
shopt -s expand_aliases
{{ 'export DEBUG=1' if env.DEBUG else '' }}
ORIGINAL_PWD=\$(pwd)"

source <(echo "$QWEX_PREAMBLE")

@source() {
  declare -p QWEX_PREAMBLE
  echo "source <(echo \"$QWEX_PREAMBLE\")"
  declare -f {% for task in tasks %}{{ task.name }} {% endfor %} @main @help @source @repl
  echo "export SOURCE=\$(@source)"
}

@help() {
  echo "Available tasks:"
{% for task in main %}
  echo "  {{ task.name }}{{ ' - ' + task.desc if task.desc else '' }}"
{% endfor %}
  echo ""
  echo "Special commands:"
  echo "  @help        - Show this help message"
  echo "  @source      - Output the full script with all task definitions"
  echo "  @repl [task] - Enter interactive QWEX REPL for a specific task or general commands"
}

{% for task in tasks %}
# Hash: {{ task.hash }}
{{ task.name }}() {
  {{ task.cmd | trim }}
}
{% endfor %}

@repl() {
  echo "Entering QWEX REPL. Type 'exit' to quit."
  local task="${1:-}"
  while true; do
    read -rp "qwex ${task:+($task)}> " input
    if [[ "$input" == "exit" ]]; then
      break
    fi
    if [[ -n "$task" ]]; then
      input="{{ prefix }}$task $input"
    fi
    @main $input || true
  done
}

@main() {
  while [[ $# -gt 0 ]]; do
    case "$1" in
      @help)
        shift
        @help
        return 0
        ;;
      @source)
        shift
        @source
        return 0
        ;;
      @repl)
        shift
        @repl "$@"
        return 0
        ;;
      *) break ;;
    esac
  done

  [[ $# -eq 0 ]] && { @help; return 0; }

  local task="{{ prefix }}$1"
  if declare -f "$task" > /dev/null; then
    shift
    "$task" "$@"
  else
    eval "$@"
  fi
}

export SOURCE=$(@source)

@main "$@"