#!/usr/bin/env bash

QWEX_PREAMBLE="set -euo{{ "x" if env.DEBUG }} pipefail
shopt -s expand_aliases
{{ "export DEBUG=1" if env.DEBUG else "" }}
ORIGINAL_PWD=\$(pwd)"

source <(echo "$QWEX_PREAMBLE")

@source() {
  declare -p QWEX_PREAMBLE
  echo "source <(echo \"$QWEX_PREAMBLE\")"
  declare -f {% for task in deps %}{{ task.name }} {% endfor %} {% for task in main %}{{ task.name }} {% endfor %} @main @help @source
  echo "@main \$@"
}

@help() {
  echo "Available tasks:"
{% for task in main %}
  echo "  {{ task.name }}{% if task.desc %} - {{ task.desc }}{% endif %}"
{% endfor %}
}

{% for task in deps %}
{% if task.desc %}
# {{ task.desc }}
{% endif %}
# Hash: {{ task.hash }}
{{ task.name }}() {
  {{ task.cmd | trim }}
}
{% endfor %}
{% for task in main %}
{% if task.desc %}
# {{ task.desc }}
{% endif %}
# Hash: {{ task.hash }}
{{ task.name }}() {
  {{ task.cmd | trim }}
}
{% endfor %}

@main() {
  local task="{{ prefix }}${1:-}"
  case "$task" in
{% for task in main %}
    "{{ task.name }}")
      shift
      {{ task.name }} "$@"
      ;;
{% endfor %}
    *)
      if declare -f "$task" > /dev/null; then
        shift
        "$task" "$@"
      else
        "$@"
      fi
      ;;
  esac
}

if [[ $# -eq 0 || $1 == "--help" || $1 == "-h" || $1 == "help" ]]; then
  @help
  exit 0
fi

@main "$@"