#!/usr/bin/env bash
QWEX_PREAMBLE="set -euo pipefail
shopt -s expand_aliases
ORIGINAL_PWD=\$(pwd)"


source <(echo "$QWEX_PREAMBLE")

@declare() {
  echo "$QWEX_PREAMBLE"
  declare -f {% for task in deps %}{{ task.name | replace(".", ":") }} {% endfor %} {% for task in main %}{{ task.name | replace(".", ":") }} {% endfor %} @main @help
}

@help() {
  echo "Available tasks:"
{% for task in main %}
  echo "  {{ task.name }}{% if task.desc %} - {{ task.desc }}{% endif %}"
{% endfor %}
}

{% for task in deps %}
{% if task.desc %}
# {{ task.desc }}
{% endif %}
# Hash: {{ task.hash }}
{{ task.name | replace(".", ":") }}() {
  {{ task.cmd }}
}

{% endfor %}
{% for task in main %}
{% if task.desc %}
# {{ task.desc }}
{% endif %}
# Hash: {{ task.hash }}
{{ task.name | replace(".", ":") }}() {
  {{ task.cmd }}
}
{% endfor %}

@main() {
  case "${1:-}" in
    ""|"-h"|"--help"|"help")
      @help
      ;;
{% for task in main %}
    "{{ task.name }}")
      shift
      {{ task.name | replace(".", ":") }} "$@"
      ;;
{% endfor %}
    *)
      echo "Unknown task: $1. Executing as a script." >&2
      eval "$@"
      ;;
  esac
}

@main "$@"
