utils:
  uses: "@std/utils"

props:
  message: "default message"

tasks:
  # Internal helper, can be inlined or called.
  # Since it's small and used in conditionals, we'll keep it compatible with 'call'
  # but here we use it inline inside the if-statement logic usually.
  # However, to support {{ tasks._should_log }} "$1", we use $1.
  _should_log:
    cmd: |
      local msg_level="$1"
      local current_level="${QWEX_LOG_LEVEL:-INFO}"
      level_to_num() {
        case "$1" in
          TRACE|trace|1) echo 1 ;;
          DEBUG|debug|2) echo 2 ;;
          INFO|info|3)   echo 3 ;;
          WARN|warn|WARNING|warning|4) echo 4 ;;
          ERROR|error|5) echo 5 ;;
          *) echo 3 ;;
        esac
      }
      local msg_num current_num
      msg_num=$(level_to_num "$msg_level")
      current_num=$(level_to_num "$current_level")
      [ "$msg_num" -ge "$current_num" ]

  trace:
    cmd: |
      {{ utils.tasks.once }} {{ utils.tasks.color }}
      if {{ tasks._should_log }} 1; then
        echo -e "${Q_GRAY}[TRACE]${Q_RESET} $1" >&2
      fi

  debug:
    cmd: |
      {{ utils.tasks.once }} {{ utils.tasks.color }}
      if {{ tasks._should_log }} 2; then
        echo -e "${Q_GRAY}[DEBUG]${Q_RESET} $1" >&2
      fi

  info:
    cmd: |
      {{ utils.tasks.once }} {{ utils.tasks.color }}
      if {{ tasks._should_log }} 3; then
        echo -e "${Q_BLUE}ℹ${Q_RESET} $1" >&2
      fi

  warn:
    cmd: |
      {{ utils.tasks.once }} {{ utils.tasks.color }}
      if {{ tasks._should_log }} 4; then
        echo -e "${Q_YELLOW}⚠${Q_RESET} $1" >&2
      fi

  error:
    cmd: |
      {{ utils.tasks.once }} {{ utils.tasks.color }}
      if {{ tasks._should_log }} 5; then
        echo -e "${Q_RED}✘${Q_RESET} $1" >&2
      fi
