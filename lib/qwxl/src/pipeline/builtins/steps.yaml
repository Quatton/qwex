utils:
  uses: "@std/utils"
log:
  uses: "@std/log"

tasks:
  # Simple step runner - executes a named step
  step:
    cmd: |
      {{ utils.tasks.once(utils.tasks.color()) }}
      {{ log.tasks.info("${Q_GRAY}┌── ${Q_BLUE}Step: $1${Q_RESET}") }}

      local command_str="$2"
      local truncated_command_str=$(echo "$command_str" | head -c 60)
      {{ log.tasks.debug("${Q_GRAY}│ Executing: ${truncated_command_str}${Q_RESET}") }}

      local start_time=$(date +%s)

      # --- EXECUTION BARRIER ---
      eval "$command_str"
      local exit_code=$?
      # -------------------------

      local end_time=$(date +%s)
      local duration=$((end_time - start_time))

      if [ $exit_code -eq 0 ]; then
        {{ log.tasks.info("${Q_GRAY}└─ ${Q_GREEN}✔ Success${Q_GRAY} (${duration}s)${Q_RESET}") }}
        return 0
      else
        {{ log.tasks.error("${Q_GRAY}└─ ${Q_RED}✘ Failed${Q_GRAY} (Exit Code: ${exit_code})${Q_RESET}") }}
        return $exit_code
      fi

  compose:
    props:
      steps:
        - name: Sample Step
    cmd: |
      {% for step in props.steps %}
        {{ tasks.step(step.name, step.run) }}
      {% endfor %}
