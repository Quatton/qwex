name: module

tasks:
  register_dependency:
    run: |
      declare -gA MODULE_DEPENDENCIES_HASHSET
      local module_name="$1"
      local deps="$2"
      MODULE_DEPENDENCIES_HASHSET["$module_name"]="$deps"

  collect_dependencies:
    run: |
      local module_name="$1"
      local deps="${MODULE_DEPENDENCIES_HASHSET[$module_name]}"
      local result=()
      for dep in $deps; do
        result+=($({{ modules.module.collect_dependencies }} "$dep"))
        result+=("$dep")
      done
      local unique_result=()
      local -A seen
      for item in "${result[@]}"; do
        if [[ -z "${seen[$item]+x}" ]]; then
          seen[$item]=1
          unique_result+=("$item")
        fi
      done
      echo "${unique_result[@]}"

  include:
    run: |
      {{ modules.std.once }} "{{ modules.std.color }}"
      {{ modules.log.debug }} "Initializing module: $@"

      local unique_result=()
      local -A seen

      local dependencies=($({{ modules.module.collect_dependencies }} "$@"))
      dependencies+=("$@")
      for item in "${dependencies[@]}"; do
        if [[ -z "${seen[$item]+x}" ]]; then
          seen[$item]=1
          unique_result+=("$item")
        fi
      done

      {{ modules.log.debug }} "${Q_BLUE}Redeclaring context for a new shell boundary...${Q_RESET}"

      declare -f "${unique_result[@]}"
