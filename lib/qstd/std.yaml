name: std

tasks:
  once:
    run: |
      declare -gA STD_ONCE_HASHSET
      local key="$1"
      if [[ -z "${STD_ONCE_HASHSET[$key]+x}" ]]; then
        STD_ONCE_HASHSET[$key]=1
        eval "$key"
      else
        true
      fi

  color:
    run: |
      if [ -t 1 ]; then
        Q_RED='\033[0;31m'
        Q_GREEN='\033[0;32m'
        Q_BLUE='\033[0;34m'
        Q_GRAY='\033[0;90m'
        Q_RESET='\033[0m'
      else
        Q_RED='' Q_GREEN='' Q_BLUE='' Q_GRAY='' Q_RESET=''
      fi

  step:
    run: |
      {{ modules.std.once }} "{{ modules.std.color }}"

      {{ modules.log.debug }} "\n${Q_GRAY}┌── ${Q_BLUE}Step: ${1}${Q_RESET}"

      local command_str="$2"
      local truncated_command_str=$(echo "$command_str" | head -c 60)
      {{ modules.log.debug }} "${Q_GRAY}│ Executing: ${truncated_command_str}${Q_RESET}"

      local start_time=$(date +%s)

      # --- EXECUTION BARRIER ---
      eval "$command_str"
      local exit_code=$?
      # -------------------------

      local end_time=$(date +%s)
      local duration=$((end_time - start_time))

      if [ $exit_code -eq 0 ]; then
        {{ modules.log.debug }} "${Q_GRAY}└─ ${Q_GREEN}✔ Success${Q_GRAY} (${duration}s)${Q_RESET}"
        return 0
      else
        {{ modules.log.debug }} "${Q_GRAY}└─ ${Q_RED}✘ Failed${Q_GRAY} (Exit Code: ${exit_code})${Q_RESET}"
        exit $exit_code
      fi
