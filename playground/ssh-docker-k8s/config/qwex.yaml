modules:
  steps:
    uses: std/steps
  log:
    uses: std/log
  tracing:
    tasks:
      generate_run_id:
        desc: "Generate a unique run ID with timestamp and random suffix"
        cmd: |
          local timestamp
          timestamp=$(date +"%Y%m%d%H%M%S")
          local random_suffix
          random_suffix=$(openssl rand -hex 4)
          local qwex_job_name=${QWEX_JOB_NAME:-job}
          echo "${timestamp}-${random_suffix}-${qwex_job_name}"

  adapter:
    vars:
      image: "ghcr.io/astral-sh/uv:python3.12-bookworm"

    tasks:
      k8s:
        vars:
          init: ""
          main: ""
          cleanup: ""
        cmd: |
          SOURCE=$(@source)

          export KUBECONFIG="${KUBECONFIG:-{{ __dir__ }}/kubeconfig}"

          # create persistent volume claim for workspace
          kubectl apply -f - <<EOF
          apiVersion: v1
          kind: PersistentVolumeClaim
          metadata:
            name: qwex-workspace-pvc
          spec:
            accessModes:
              - ReadWriteOnce
            resources:  
              requests:
                storage: 1Gi
          EOF
          # wait for pvc to be bound

          kubectl wait --for=jsonpath='{.status.phase}'=Bound pvc/qwex-pvc --timeout=60s

          kubectl run qwex-job --rm -i --restart=Never --image={{ vars.image }} --overrides='
          {
            "apiVersion": "v1",
            "spec": {
              "containers": [{
                "name": "qwex-container",
                "image": "{{ vars.image }}",
                "volumeMounts": [{
                  "mountPath": "/workspace",
                  "name": "workspace-volume"
                }],
                "env": [
                  {
                    "name": "QWEX_RUN_DIR",
                    "value": "'"${QWEX_RUN_DIR:-}"'"
                  },
                  {
                    "name": "QWEX_JOB_NAME",
                    "value": "'"${QWEX_JOB_NAME:-}"'"
                  },
                  {
                    "name": "QWEX_RUN_ID",
                    "value": "'"${QWEX_RUN_ID:-}"'"
                  },
                  {
                    "name": "QWEX_INIT_CMD",
                    "value": "'"${QWEX_INIT_CMD:-}"'"
                  },
                  {
                    "name": "QWEX_MAIN_CMD",
                    "value": "'"${QWEX_MAIN_CMD:-}"'"
                  },
                  {
                    "name": "QWEX_CLEANUP_CMD",
                    "value": "'"${QWEX_CLEANUP_CMD:-}"'"
                  }
                ]
              }],
              "volumes": [{
                "name": "workspace-volume",
                "persistentVolumeClaim": {
                  "claimName": "qwex-workspace-pvc"
                }
              }]
            }
          }' -- /bin/bash -c '
            '"${SOURCE}"'

            {{
                tasks.local.inline({
                  init: "${QWEX_INIT_CMD:-}",
                  main: "${QWEX_MAIN_CMD:-}",
                  cleanup: "${QWEX_CLEANUP_CMD:-}"
                })
            }}
          '

      ssh:
        vars:
          init: ""
          main: ""
          cleanup: ""
        cmd: |
          SOURCE=$(@source)

          ssh -o StrictHostKeyChecking=no -p 2222 qwex_user@localhost /bin/bash -c '
            export QWEX_RUN_DIR="${QWEX_RUN_DIR:-}"
            export QWEX_JOB_NAME="${QWEX_JOB_NAME:-}"
            export QWEX_RUN_ID="${QWEX_RUN_ID:-}"
            export QWEX_INIT_CMD="${QWEX_INIT_CMD:-}"
            export QWEX_MAIN_CMD="${QWEX_MAIN_CMD:-}"
            export QWEX_CLEANUP_CMD="${QWEX_CLEANUP_CMD:-}"
            '"${SOURCE}"'
            
            {{
                tasks.local.inline({
                  init: "${QWEX_INIT_CMD:-}",
                  main: "${QWEX_MAIN_CMD:-}",
                  cleanup: "${QWEX_CLEANUP_CMD:-}"
                })
            }}
          '

      docker:
        vars:
          init: ""
          main: ""
          cleanup: ""
        cmd: |
          SOURCE=$(@source)

          docker run --rm -it \
            -v "$(pwd)":/workspace \
            -w /workspace \
            -e QWEX_RUN_DIR="${QWEX_RUN_DIR:-}" \
            -e QWEX_JOB_NAME="${QWEX_JOB_NAME:-}" \
            -e QWEX_RUN_ID="${QWEX_RUN_ID:-}" \
            -e QWEX_INIT_CMD="${QWEX_INIT_CMD:-}" \
            -e QWEX_MAIN_CMD="${QWEX_MAIN_CMD:-}" \
            -e QWEX_CLEANUP_CMD="${QWEX_CLEANUP_CMD:-}" \
            {{ vars.image }} /bin/bash -c '
              '"${SOURCE}"'

              {{
                 tasks.local.inline({
                   init: "${QWEX_INIT_CMD:-}",
                   main: "${QWEX_MAIN_CMD:-}",
                   cleanup: "${QWEX_CLEANUP_CMD:-}"
                 })
              }}
            '

      local:
        vars:
          init: ""
          main: ""
          cleanup: ""
        cmd: |
          {% if vars.cleanup or QWEX_CLEANUP_CMD %}
          trap '{{ vars.cleanup or QWEX_CLEANUP_CMD }}' EXIT
          {% endif %}

          {% if vars.init or QWEX_INIT_CMD %}
            {{ vars.init or QWEX_INIT_CMD }}
          {% endif %}

          {% if vars.main or QWEX_MAIN_CMD %}
            if [ -n "${QWEX_RUN_DIR+set}" ]; then
              {{ vars.main or QWEX_MAIN_CMD }} | tee "$QWEX_RUN_DIR/logs/main.log"
            else
              {{ log.tasks.info }} "QWEX_RUN_DIR not set, running main command without logging to QWEX run directory."
              {{ vars.main or QWEX_MAIN_CMD }}
            fi
          {% else %}
            {{ log.tasks.warn }} "No main command provided to adapter.run.task.run. Nothing to execute."
          {% endif %}

tasks[docker]:
  adapt:
    uses: modules.adapter.tasks.docker
    vars:
      init: "{{ vars.init | default('') }}"
      main: "{{ vars.main | default('') }}"
      cleanup: "{{ vars.cleanup | default('') }}"

tasks[ssh]:
  adapt:
    uses: modules.adapter.tasks.ssh
    vars:
      init: "{{ vars.init | default('') }}"
      main: "{{ vars.main | default('') }}"
      cleanup: "{{ vars.cleanup | default('') }}"

tasks[k8s]:
  adapt:
    uses: modules.adapter.tasks.k8s
    vars:
      init: "{{ vars.init | default('') }}"
      main: "{{ vars.main | default('') }}"
      cleanup: "{{ vars.cleanup | default('') }}"

tasks:
  adapt:
    uses: modules.adapter.tasks.local
    vars:
      init: "{{ vars.init | default('') }}"
      main: "{{ vars.main | default('') }}"
      cleanup: "{{ vars.cleanup | default('') }}"
  init:
    uses: modules.steps.tasks.compose
    vars:
      steps:
        - desc: "Generate run ID if not already set"
          cmd: |
            if [ -z "${QWEX_RUN_ID+set}" ]; then
              export QWEX_RUN_ID=$( {{ modules.tracing.tasks.generate_run_id }} )
              {{ log.tasks.info }} "Generated QWEX_RUN_ID: $QWEX_RUN_ID"
            else
              {{ log.tasks.info }} "Using existing QWEX_RUN_ID: $QWEX_RUN_ID"
            fi
        - desc: "Make .qwex/runs directory"
          cmd: |
            mkdir -p .qwex/runs
        - desc: "Make run directory"
          cmd: |
            export QWEX_RUN_DIR=".qwex/runs/$QWEX_RUN_ID"
            mkdir -p "$QWEX_RUN_DIR"
            {{ log.tasks.info }} "Created QWEX run directory at $QWEX_RUN_DIR"
        - desc: "Make meta directory"
          cmd: |
            mkdir -p "$QWEX_RUN_DIR/meta"
        - desc: "Make created_at and status files"
          cmd: |
            date +"%Y-%m-%d %H:%M:%S" > "$QWEX_RUN_DIR/meta/created_at"
            echo "created" > "$QWEX_RUN_DIR/meta/status"
        - desc: "Create logs directory"
          cmd: |
            mkdir -p "$QWEX_RUN_DIR/logs"
        - desc: "Make sure venv is created"
          cmd: |
            if [ ! -d ".venv" ]; then
              uv venv
            fi
        - desc: "Activate venv"
          cmd: |
            source .venv/bin/activate
        - desc: "Install dependencies"
          cmd: |
            uv sync
        - desc: "Log initialization complete"
          cmd: |
            {{ log.tasks.info }} "QWEX initialization complete."
            date +"%Y-%m-%d %H:%M:%S" > "$QWEX_RUN_DIR/meta/initialized_at"
            echo "initialized" > "$QWEX_RUN_DIR/meta/status"

  run:
    cmd: |
      local command="${*:-}"
      if [ -z "$command" ]; then
        {{ log.tasks.error }} "No command provided to run task."
        return 1
      fi

      {{ tasks.adapt.inline({ init: tasks.init, main: "$command", cleanup: "" }) }}
