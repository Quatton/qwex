vars:
  demo_dir: "{{ './demo' | resolvePath(__dir__) }}"

modules:
  steps:
    uses: std/steps
  log:
    uses: std/log

tasks:
  setup:
    desc: "Setup task to ensure prerequisites are met"
    uses: modules.steps.tasks.compose
    vars:
      steps:
        - desc: "Create temp directory"
          cmd: |
            cd {{ __dir__ }}
            mkdir -p {{ vars.demo_dir }}
        - desc: "Initialize uv project"
          cmd: |
            cd {{ __dir__ }}
            uv init --no-workspace {{ vars.demo_dir }}
        - desc: "Symlink ./config/* to demo_dir"
          cmd: |
            cd {{ __dir__ }}
            ln -s {{ vars.demo_dir }}/config/* {{ vars.demo_dir }}
        - desc: "Check if qwex is installed"
          cmd: |
            if ! command -v qwex &> /dev/null; then
              {{ log.tasks.error }} "qwex could not be found. Please install qwex to proceed."
              exit 1
            else
              {{ log.tasks.info }} "qwex is installed."
            fi
        - desc: "Setup docker with ssh capabilities"
          cmd: |
            if docker ps -a | grep qwex-ssh-server; then
              {{ log.tasks.info }} "qwex-ssh-server Docker container already exists."
            else
              {{ log.tasks.info }} "Creating qwex-ssh-server Docker container."
              docker run -d \
                  -e USER_NAME=qwex_user \
                  -e USER_PASSWORD=qwex_pass \
                  -e PASSWORD_ACCESS=true \
                  -p 2222:2222 \
                  --name qwex-ssh-server \
                  linuxserver/openssh-server
            fi
        - desc: "Setup minio service in Docker"
          cmd: |
            if docker ps -a | grep qwex-minio; then
              {{ log.tasks.info }} "qwex-minio Docker container already exists."
            else
              {{ log.tasks.info }} "Creating qwex-minio Docker container."
              docker run -d -p 9000:9000 -p 9001:9001 --name qwex-minio \
                  -e "MINIO_ROOT_USER=admin" \
                  -e "MINIO_ROOT_PASSWORD=password" \
                  minio/minio server /data --console-address ":9001"
            fi
        - desc: "Check if kind is installed"
          cmd: |
            if ! command -v kind &> /dev/null; then
              {{ log.tasks.error }} "kind could not be found. Please install kind to proceed."
              exit 1
            else
              {{ log.tasks.info }} "kind is installed."
            fi
        - desc: "Create local k8s cluster with kind"
          cmd: |
            if kind get clusters | grep qwex-cluster; then
              {{ log.tasks.info }} "k8s cluster 'qwex-cluster' already exists."
            else
              {{ log.tasks.info }} "Creating k8s cluster 'qwex-cluster' with kind."
              kind create cluster --name qwex-cluster
            fi
        - desc: "Export KUBECONFIG to {{ vars.demo_dir }}/kubeconfig"
          cmd: |
            kind get kubeconfig --name="qwex-cluster" > {{ vars.demo_dir }}/kubeconfig

            export KUBECONFIG={{ vars.demo_dir }}/kubeconfig
        - desc: "Verify k8s cluster is running"
          cmd: |
            kubectl cluster-info

  test:
    desc: "UV workspace with lifecycle executed with k8s, docker, and ssh using qwex"
    uses: modules.steps.tasks.compose
    vars:
      steps:
        - desc: "Run `qwex run uv run hello.py` in demo_dir"
          cmd: |
            cd {{ vars.demo_dir }}
            QWEX_JOB_NAME="original" qwex run uv run hello.py
        - desc: "Modify hello.py to say other message"
          cmd: |
            cd {{ vars.demo_dir }}
            echo 'print("Hello from modified hello.py!")' > {{ vars.demo_dir }}/hello.py
        - desc: "Run `qwex run uv run hello.py` again to see modified output"
          cmd: |
            cd {{ vars.demo_dir }}
            QWEX_JOB_NAME="modified" qwex run uv run hello.py
        - desc: "Modify hello.py to say a Docker message"
          cmd: |
            cd {{ vars.demo_dir }}
            echo 'print("Hello from Dockerized hello.py!")' > {{ vars.demo_dir }}/hello.py
        - desc: "Run `qwex run uv run hello.py` again to see Dockerized output"
          cmd: |
            cd {{ vars.demo_dir }}
            QWEX_JOB_NAME="dockerized" qwex run uv run hello.py
        - desc: "Modify hello.py to say an SSH message"
          cmd: |
            cd {{ vars.demo_dir }}
            echo 'print("Hello from SSH hello.py!")' > {{ vars.demo_dir }}/hello.py
        - desc: "Run `qwex run uv run hello.py` again to see SSH output"
          cmd: |
            cd {{ vars.demo_dir }}
            QWEX_JOB_NAME="ssh" qwex run uv run hello.py

  clean:
    desc: "Clean up temp directory created during test"
    cmd: |
      if [ -d "{{ vars.demo_dir }}" ]; then
        rm -rf "{{ vars.demo_dir }}"
        {{ log.tasks.info }} "{{ vars.demo_dir }}: Cleaned up temp directory"
      else
        {{ log.tasks.warn }} "{{ vars.demo_dir }}: No temp directory info found for cleanup."
      fi

      if docker ps -a | grep qwex-ssh-server; then
        docker stop qwex-ssh-server
        docker rm qwex-ssh-server
        {{ log.tasks.info }} "Stopped and removed qwex-ssh-server Docker container."
      else
        {{ log.tasks.warn }} "No qwex-ssh-server Docker container found for cleanup."
      fi

      if kind get clusters | grep qwex-cluster; then
        kind delete cluster --name qwex-cluster
        {{ log.tasks.info }} "Deleted k8s cluster 'qwex-cluster'."
      else
        {{ log.tasks.warn }} "No k8s cluster 'qwex-cluster' found for cleanup."
      fi

      if [ -f "{{ vars.demo_dir }}/config/kubeconfig" ]; then
        rm "{{ vars.demo_dir }}/config/kubeconfig"
        {{ log.tasks.info }} "Removed kubeconfig file."
      else
        {{ log.tasks.warn }} "No kubeconfig file found for cleanup."
      fi

  all:
    desc: "Test from clean state"
    uses: modules.steps.tasks.compose
    vars:
      steps:
        - desc: "Clean up"
          cmd: "{{ tasks.clean }}"
        - desc: "Setup prerequisites"
          cmd: "{{ tasks.setup }}"
        - desc: "Run tests"
          cmd: "{{ tasks.test }}"
        - desc: "All done"
          cmd: "{{ log.tasks.info }} 'UV workspace test completed.'"
