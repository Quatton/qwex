vars:
  ssh_host: "{{ env.SSH_HOST }}"
  ssh_user: "{{ env.SSH_USER }}"

tasks:
  submit:
    desc: "Submit command to remote driver"
    vars:
      env: []
      init: ""
      main: ""
      cleanup: ""
    cmd: |
      {% if features.ssh %}
        {{ tasks.ssh.inline(
          env=vars.env,
          init=vars.init,
          main=vars.main,
          cleanup=vars.cleanup
        ) }}
      {% else %}
        {{ tasks.local.inline(
          env=vars.env,
          init=vars.init,
          main=vars.main,
          cleanup=vars.cleanup
        ) }}
      {% endif %}

  retrieve:
    desc: "Retrieve files or directories from remote host"
    vars:
      remote_path: ""
      local_path: ""
    cmd: |
      {% if features.ssh %}
        rsync -avz -e "ssh" {{ vars.ssh_user }}@{{ vars.ssh_host }}:{{ vars.remote_path }} {{ vars.local_path }}
      {% else %}
        cp -r {{ vars.remote_path }} {{ vars.local_path }}
      {% endif %}

  ssh:
    vars:
      env: []
      init: ""
      main: ""
      cleanup: ""
    cmd: |
      local source_b64
      source_b64=$(@source | base64 -w 0)

      local env_b64
      env_b64=$(cat <<EOF | base64 -w 0
      {% for env_var in vars.env -%}
      {% if '=' in env_var -%}
      export {{ env_var }}
      {% else -%}
      export {{ env_var }}="{% raw %}${% endraw %}{{ env_var }}"
      {% endif %}
      {% endfor -%}
      EOF
      )

      local cmd_b64
      cmd_b64=$(cat <<'EOF' | base64 -w 0
      f() {
      {{ tasks.local.inline(
        env=vars.env,
        init=vars.init,
        main=vars.main,
        cleanup=vars.cleanup
      ) }}
      }
      f
      EOF
      )

      ssh -t {{ vars.ssh_user }}@{{ vars.ssh_host }} \
        "SOURCE_B64='$source_b64' ENV_B64='$env_b64' CMD_B64='$cmd_b64' bash -c '"'
          source <(echo "$SOURCE_B64" | base64 -d)
          eval "$(echo "$ENV_B64" | base64 -d)"
          eval "$(echo "$CMD_B64" | base64 -d)"
        '"'"

  local:
    vars:
      env: []
      init: ""
      main: ""
      cleanup: ""

    cmd: |

      {% if vars.cleanup %}
      __cleanup() {
      {{ vars.cleanup }}
      }
      trap '__cleanup' EXIT
      {% endif %}

      {% if vars.init %}
      {{ vars.init }}
      {% endif %}

      {% if vars.main %}
      {{ vars.main }}
      {% else %}
      echo "No main command provided. Nothing to execute."
      {% endif %}
