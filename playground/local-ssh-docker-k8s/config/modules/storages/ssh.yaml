name: storage

uses:
  local: ./local.yaml
  ssh: shell/ssh

vars:
  ssh_host: "${QWEX_SSH_HOST:-}"
  ssh_user: "${QWEX_SSH_USER:-$USER}"
  workspace: ""

with:
  ssh:
    host: "{{ ssh_user }}@{{ ssh_host }}"
  local:
    workspace: "{{ workspace }}"

tasks:
  dir:
    run: |
      {{ local.dir }} "$@"
  
  write:
    run: |
      {{ ssh.exec }} "mkdir -p '$(dirname "$1")' && echo '${@:2}' > '$1'"
  
  read:
    run: |
      {{ ssh.exec }} "cat '$1' 2>/dev/null"
  
  exec:
    run: |
      {{ ssh.exec }} "$@"
  
  tail:
    run: |
      {{ ssh.exec }} "tail -f '$1'"
  
  set_status:
    run: |
      {{ write }} "$({{ dir }} "$1")/meta/status" "$2"
  
  mount:
    run: |
      {{ local.mount }}
  
  sync:
    run: |
      local run_id="$1"
      local remote_dir=$({{ dir }} "$run_id")
      local local_dir=$({{ local.dir }} "$run_id")
      mkdir -p "$local_dir"
      rsync -avz "{{ ssh_user }}@{{ ssh_host }}:${remote_dir}/" "${local_dir}/"
