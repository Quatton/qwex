modules:
  parallel:
    modules:
      log:
        uses: std/log
    tasks:
      compose:
        vars:
          tasks:
            - cmd: ""
              name: ""
        cmd: |
          pids=()
          {% for task in vars.tasks %}
          (
            exec 1> >(sed "s/^/[{{ task.name | escape }}] /" >&2)
            exec 2> >(sed "s/^/[{{ task.name | escape }}] /" >&2)
            {{ log.info }} "Starting task: {{ task.name | escape }}"
            {{ task.cmd }} 
            {{ log.info }} "Completed task: {{ task.name | escape }}"
          ) &
          pids+=($!)
          {% endfor %}

          for pid in "${pids[@]}"; do
            wait $pid
          done

tasks:
  clean:
    uses: modules.parallel.tasks.compose
    vars:
      tasks:
        - name: "UV Workspace"
          cmd: "cd {{ __dir__ }}/uv-workspace && qwex clean"
        - name: "Lifecycle"
          cmd: "cd {{ __dir__ }}/lifecycle && qwex clean"
        - name: "Docker"
          cmd: "cd {{ __dir__ }}/docker && qwex clean"

  all:
    uses: modules.parallel.tasks.compose
    vars:
      tasks:
        - name: "UV Workspace"
          cmd: "cd {{ __dir__ }}/uv-workspace && qwex all"
        - name: "Lifecycle"
          cmd: "cd {{ __dir__ }}/lifecycle && qwex all"
        - name: "Docker"
          cmd: "cd {{ __dir__ }}/docker && qwex all"
  test:
    uses: modules.parallel.tasks.compose
    vars:
      tasks:
        - name: "UV Workspace"
          cmd: "cd {{ __dir__ }}/uv-workspace && qwex test"
        - name: "Lifecycle"
          cmd: "cd {{ __dir__ }}/lifecycle && qwex test"
        - name: "Docker"
          cmd: "cd {{ __dir__ }}/docker && qwex test"
